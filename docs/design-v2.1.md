
### **CodeWiki IDE 插件设计文档 (V2.1)**

**版本**: 2.1 (MVP - 半自动化辅助生成)
**修订日期**: 2025-06-14
**说明**: 本文档是在 V2.0 基础上修订的第一个可交付版本（MVP）。它定义了一个功能范围明确的“写作助手”插件，旨在通过高质量的提示词模板和流畅的交互体验，辅助开发者高效生成**单个**软件设计文档章节。

## 1. 工具概述

CodeWiki 是一个旨在加速软件设计文档编写的 IDE 插件。在 V2.1 版本中，它通过人机协作的方式，专注于提升文档撰写的效率和质量。

### 1.1. V2.1 版本目标

本版本的核心目标是**验证核心价值并快速交付**。我们不追求完全的自动化，而是将插件定位为开发者的“智能副驾驶”，通过提供结构化的模板和强大的编辑功能，帮助用户将精力集中在提供高质量的上下文和最终内容的审查上。

### 1.2. 核心功能 (V2.1 MVP)

1.  **模板驱动的文档生成**: 提供一系列专家预设的提示词模板，用于生成标准化的设计文档章节（如数据模型、接口定义、核心算法等）。
2.  **用户主导的上下文提供**: 用户完全掌控上下文的提供，通过从 IDE 中复制粘贴的方式，将相关的代码、SQL 或其他文本注入到模板中。
3.  **沉浸式对话与编辑**: 在 VS Code 侧边栏提供一个集成了提示词管理、对话交互和内容编辑的无缝体验。

### 1.3. V2.1 范围外的功能

为确保快速交付，以下功能被明确排除在此版本范围之外：
* 自动扫描和分析代码库。
* 自动构建和填充上下文。
* 一键生成完整的、多章节的设计文档。
* 代码与设计文档之间的双向追溯链接或交互图。

## 2. 插件界面与核心功能

插件所有功能均在 IDE 侧边栏一个名为 “CodeWiki” 的主视图中实现，通过在**单一的 Webview** 内进行前端路由切换，提供无缝的单页应用 (SPA) 体验。

### 2.1. 侧边栏布局与交互
(与 V2.0 设计一致)
* **顶部图标栏**: 包含**新建对话**、**对话**、**历史**、**提示词** (`<-- 本阶段核心入口`)、**设置**的快捷入口。
* **视图切换**: 点击图标可立即切换下方的主内容区。
* **欢迎页面**: 引导用户开始新对话或使用提示词模板。

### 2.2. 对话窗口
(与 V2.0 设计一致)
作为用户与大模型交互的核心界面，提供沉浸式、无干扰的交流体验。
* **消息布局与样式**: 文档式流布局，保留呼吸空间。
* **消息悬浮工具栏**: 提供折叠/展开、复制、重新生成、编辑等功能。
* **底部消息编辑区**: 固定布局，文本域高度动态增长。关键是**最大化编辑按钮 (`codicon-screen-full`)**，它对于本版本中处理大量粘贴代码的场景至关重要。
* **专注编辑模式**: 点击“最大化编辑”后，在主编辑区打开新的 `WebviewPanel`，与侧边栏输入区内容严格双向同步，为用户审查和编辑大量上下文提供了充足空间。
* **快捷功能栏**: 提供提示词模板和模型选择的下拉菜单。
* **响应状态处理**: 完善的请求失败和用户中断处理机制。

### 2.3. 对话管理 (历史视图)
(与 V2.0 设计一致)
提供对话历史的查看、删除和导出功能。

### 2.4. 提示词管理
**此模块是 V2.1 MVP 的功能核心。**
(与 V2.0 设计一致)
此模块用于创建、组织和复用高质量的提示词模板。
* **主列表视图**: 展示所有模板，提供新建和搜索功能。
* **创建与编辑流程**: 在 Webview 内直接切换到表单视图，用于编辑模板的“标题”和“内容”。模板内容应包含清晰的占位符，以指导用户粘贴上下文，例如：
    ```markdown
    # 生成数据模型章节

    请根据下方提供的 SQL 表结构和相关的代码定义，撰写“数据模型”部分的 Markdown 文档。

    ## SQL 结构
    [请在此处粘贴您的 SQL 表结构]

    ## 代码定义 (DTO/Entity)
    [请在此处粘贴相关的 TypeScript/Java 类定义]
    ```

### 2.5. 设置
(与 V2.0 设计一致)
支持模型 API 的相关配置，配置信息以明文形式存储在 `globalState` 中。

### 2.6. 核心工作流：半自动化文档生成
这是 V2.1 标志性的用户旅程：
1.  **选择模板**: 用户在侧边栏进入**提示词**视图，选择一个任务模板，如“生成 API 接口文档”。
2.  **填充模板**: 点击后，模板内容连同占位符一同加载到底部的输入框中。
3.  **准备上下文**: 用户切换到 IDE 的主编辑器，手动复制需要分析的 API 控制器代码、服务代码等。
4.  **粘贴上下文**: 用户返回 CodeWiki 侧边栏，将复制的内容粘贴到输入框中对应的占位符位置。为了处理大量代码，用户很可能会使用**专注编辑模式**。
5.  **生成章节**: 点击“发送”按钮。
6.  **获取结果**: 模型返回的文档章节以流式响应显示在对话区域。
7.  **迭代与组合**: 用户可以复制生成的 Markdown，或基于结果进行追问、编辑，然后手动将各个生成的章节组合成一份完整的 `DESIGN.md` 文档。

## 3. 模型交互与非功能性需求
(与 V2.0 设计一致)
* **模型对话交互**: 支持流式响应与中断、历史消息编辑、错误处理与重试。
* **非功能性需求**: 保证性能、易用性、稳定性，并与 VS Code 主题风格保持一致。

---
## 4. 代码实现规划与代码仓结构 (V2.1)

此阶段的架构保持精简，完全复用 V2.0 的设计，专注于快速实现核心的辅助生成功能。

### 4.1. 技术选型
* **开发语言**: **TypeScript**。
* **核心框架**: **VS Code Extension API**。
* **UI 渲染**: **单一 WebviewView** + **原生 TypeScript/HTML/CSS**。
* **LLM 开发库**: 暂不引入复杂库。可使用 `node-fetch` 或 `axios` 直接调用模型 API。(`langchain.js` 作为未来版本的技术储备)。

### 4.2. 架构设计
架构与 V2.0 完全一致，是一个精简高效的 **Extension Host (后端) + 单一 WebviewView (前端)** 模型。
* **Extension Host**: 负责管理 Webview (`CodeWikiViewProvider`)、持久化状态 (`StateManager`) 和代理 LLM API 请求 (`LLMService`)。
* **WebviewView**: 负责渲染所有 UI 界面、响应用户操作，并通过 `postMessage` 与后端通信。

### 4.3. 代码仓结构详解
代码结构在 V2.0 基础上，增加一个用于存放预设提示词的 `json` 文件。
```plaintext
.
├── package.json
├── tsconfig.json
└── src/
    ├── common/
    │   ├── default-models.json
    │   ├── default-prompts.json  # [新增] 存放预置的提示词模板
    │   └── types.ts
    │
    ├── extension/
    │   ├── extension.ts
    │   ├── CodeWikiViewProvider.ts
    │   ├── StateManager.ts
    │   └── LLMService.ts         # 保持为轻量级的 API 服务代理
    │
    └── webview/
        ├── main.ts
        ├── vscode.ts
        │
        ├── views/
        │   ├── App.ts
        │   ├── ... (所有 V2.0 视图均保持不变)
        │
        ├── components/
        │   └── MessageBlock.ts
        │
        └── css/
            └── main.css
```

## 5. V2.1 开发重点与验收标准

1.  **任务一：高质量提示词工程**
    * **开发重点**: 设计并内置 5-8 个覆盖核心场景（如模块概述、API 设计、数据模型、算法逻辑）的提示词模板，并存放在 `default-prompts.json` 中。
    * **验收标准**: 模板指令清晰，占位符明确；对于典型的输入，生成的文档章节格式规范、内容准确。
2.  **任务二：大上下文编辑体验优化**
    * **开发重点**: 确保 `<textarea>` 和专注编辑模式能够稳定、流畅地处理和编辑大段（如超过 1000 行）的代码粘贴。
    * **验收标准**: 在粘贴大量代码后，UI 无卡顿，双向同步无延迟或数据丢失。
3.  **任务三：核心工作流打通与优化**
    * **开发重点**: 确保“模板选择 -> 上下文填充 -> 发送 -> 接收结果”的流程完整、顺畅。
    * **验收标准**: 用户可以无障碍地完成一次设计文档章节的生成，所有按钮和状态反馈均符合预期。

## 6. 局限性与未来展望

**V2.1 的局限性**:
* **用户操作负担**: 用户需要手动完成所有上下文的收集和整理工作，较为繁琐。
* **缺乏全局视角**: 由于一次只处理一个章节，无法保证整个设计文档的全局一致性。

**未来展望**:
V2.1 作为 MVP，其最大的成功将是验证核心价值并沉淀下宝贵的资产——**经过实战检验的高质量提示词模板**。这些资产将是后续版本迭代的基石。

* **V2.2 (增强半自动化)**: 将引入“一键上下文收集”功能，自动抓取文件结构和代码内容，减轻用户负担。
* **V3.0 (全自动化)**: 将集成 `CleanArch` 等静态分析工具和 `langchain.js`，实现对代码的深度理解和智能分析，最终达成一键生成完整、高质量设计文档的终极目标。